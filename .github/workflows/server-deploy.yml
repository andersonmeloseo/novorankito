name: Server Deploy

on:
  workflow_run:
    workflows: ["Build and Deploy"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment..."
          cd /home/kaik/projetos/projeto-davi-melo-rankito/rankito
          
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ”§ Checking Node version..."
          node --version
          if ! node --version | grep -q "v20"; then
            echo "âš ï¸  Node 20 required. Installing..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
          fi
          
          echo "ğŸ§¹ Cleaning old dependencies..."
          rm -rf node_modules package-lock.json
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --omit=optional
          
          echo "ğŸ—ï¸ Building project..."
          npm run build
          
          echo "ğŸ”„ Restarting PM2..."
          pm2 restart rankito || pm2 start ecosystem.config.cjs
          
          echo "âœ… Verifying deployment..."
          pm2 status
          pm2 logs rankito --lines 5
          
          echo "ğŸš€ Deploy completed successfully!"
