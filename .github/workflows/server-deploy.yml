name: Server Deploy

on:
  workflow_run:
    workflows: ["Build and Deploy"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e

          echo "ğŸš€ Deploy iniciado em $(date)"
          cd /opt/novo-rankito

          echo "ğŸ“¥ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/main

          echo "ï¿½ Instalando dependÃªncias..."
          export HOME="/root"
          export PATH="$PATH:/usr/local/bin:/usr/bin:/bin"
          npm install --prefer-offline

          echo "ğŸ—ï¸ Fazendo build..."
          ./node_modules/.bin/vite build

          echo "ğŸ”„ Recarregando Nginx..."
          nginx -t && systemctl reload nginx

          echo "âœ… Deploy concluÃ­do em $(date)"
